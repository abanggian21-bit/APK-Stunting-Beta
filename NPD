import React, { useState, useMemo } from 'react';
import { 
  LayoutDashboard, Users, ClipboardCheck, TrendingUp, BookOpen, 
  LogOut, Droplets, HandHelping, Activity, Search, CheckCircle2, 
  Clock, AlertTriangle, ChevronRight, Plus, Info 
} from 'lucide-react';

/**
 * DATA SIMULASI (Mock Data)
 * Sesuai dengan spesifikasi input: Identitas, TB/BB, Suplemen, Dosis, Kader.
 */
const INITIAL_BALITA = [
  {
    id: "B001",
    nama: "Andi Wijaya",
    nik: "3273010101230001",
    usia: 24,
    gender: "Laki-laki",
    ortu: "Siti Aminah",
    tbAwal: 80.5,
    bbAwal: 10.2,
    tbSekarang: 82.0,
    bbSekarang: 10.8,
    obat: "Vitamin A & Zinc",
    dosis: "1 x 1 tablet",
    periode: 6,
    kader: "Ibu Ratna",
    absensi: [true, true, false, true, true, true, false],
    statusGizi: "Stunting Ringan",
    catatan: "Nafsu makan membaik"
  },
  {
    id: "B002",
    nama: "Siska Putri",
    nik: "3273010101230002",
    usia: 18,
    gender: "Perempuan",
    ortu: "Budi Santoso",
    tbAwal: 75.0,
    bbAwal: 8.5,
    tbSekarang: 75.2,
    bbSekarang: 8.6,
    obat: "Zat Besi (Fe)",
    dosis: "1 x 1 sendok takar",
    periode: 3,
    kader: "Ibu Sari",
    absensi: [true, true, true, true, true, true, true],
    statusGizi: "Sangat Pendek",
    catatan: "Sering batuk pilek"
  }
];

const App = () => {
  const [isLoggedIn, setIsLoggedIn] = useState(false);
  const [userRole, setUserRole] = useState(null); // 'admin' atau 'kader'
  const [activeTab, setActiveTab] = useState('dashboard');
  const [balitaList, setBalitaList] = useState(INITIAL_BALITA);
  const [searchTerm, setSearchTerm] = useState('');
  const [stepObat, setStepObat] = useState(0);

  // --- Fungsi Autentikasi ---
  const handleLogin = (role) => {
    setUserRole(role);
    setIsLoggedIn(true);
    setActiveTab('dashboard');
  };

  const handleLogout = () => {
    setIsLoggedIn(false);
    setUserRole(null);
  };

  // --- Perhitungan Statistik ---
  const calculateCompliance = (absensi) => {
    if (!absensi || absensi.length === 0) return 0;
    const present = absensi.filter(a => a).length;
    return Math.round((present / absensi.length) * 100);
  };

  const filteredBalita = balitaList.filter(b => 
    b.nama.toLowerCase().includes(searchTerm.toLowerCase()) || 
    b.nik.includes(searchTerm)
  );

  const stats = useMemo(() => {
    const total = balitaList.length;
    const avgCompliance = balitaList.reduce((acc, b) => acc + calculateCompliance(b.absensi), 0) / (total || 1);
    const highRisk = balitaList.filter(b => calculateCompliance(b.absensi) < 75).length;
    return { total, avgCompliance: Math.round(avgCompliance), highRisk };
  }, [balitaList]);

  // --- Fungsi Absensi ---
  const toggleAbsensi = (id, dayIdx) => {
    setBalitaList(prev => prev.map(b => {
      if (b.id === id) {
        const newAbsensi = [...b.absensi];
        newAbsensi[dayIdx] = !newAbsensi[dayIdx];
        return { ...b, absensi: newAbsensi };
      }
      return b;
    }));
  };

  // --- LAYAR LOGIN ---
  if (!isLoggedIn) {
    return (
      <div className="min-h-screen bg-slate-900 flex items-center justify-center p-6 font-sans">
        <div className="bg-white w-full max-w-md rounded-[2rem] shadow-2xl p-10 text-center relative overflow-hidden">
          <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 to-indigo-600"></div>
          <div className="w-20 h-20 bg-indigo-50 rounded-2xl flex items-center justify-center mx-auto mb-6 transform rotate-3">
            <HandHelping size={40} className="text-indigo-600" />
          </div>
          <h1 className="text-3xl font-black text-slate-800">CegahStunting</h1>
          <p className="text-slate-500 mt-2 mb-10 text-sm italic">Sistem Absensi & Edukasi Kader Posyandu</p>
          
          <div className="space-y-4">
            <button onClick={() => handleLogin('kader')} className="w-full flex items-center justify-between p-5 bg-slate-50 hover:bg-indigo-50 border-2 border-transparent hover:border-indigo-100 rounded-2xl transition-all group">
              <div className="flex items-center space-x-4">
                <div className="bg-white p-2 rounded-lg shadow-sm group-hover:bg-indigo-600 group-hover:text-white transition-all"><ClipboardCheck size={20} /></div>
                <div className="text-left"><p className="font-bold text-slate-800">Masuk sebagai Kader</p><p className="text-[10px] text-slate-400 uppercase tracking-widest font-bold">Input Harian</p></div>
              </div>
              <ChevronRight size={18} className="text-slate-300 group-hover:text-indigo-600" />
            </button>

            <button onClick={() => handleLogin('admin')} className="w-full flex items-center justify-between p-5 bg-slate-50 hover:bg-emerald-50 border-2 border-transparent hover:border-emerald-100 rounded-2xl transition-all group">
              <div className="flex items-center space-x-4">
                <div className="bg-white p-2 rounded-lg shadow-sm group-hover:bg-emerald-600 group-hover:text-white transition-all"><LayoutDashboard size={20} /></div>
                <div className="text-left"><p className="font-bold text-slate-800">Masuk sebagai Admin</p><p className="text-[10px] text-slate-400 uppercase tracking-widest font-bold">Laporan Wilayah</p></div>
              </div>
              <ChevronRight size={18} className="text-slate-300 group-hover:text-emerald-600" />
            </button>
          </div>
          <p className="mt-10 text-[10px] text-slate-300 font-bold uppercase tracking-[0.2em]">Prototype v1.0.0</p>
        </div>
      </div>
    );
  }

  // --- LAYAR UTAMA (DASHBOARD) ---
  return (
    <div className="flex min-h-screen bg-slate-50 font-sans text-slate-900">
      {/* Sidebar Navigasi */}
      <aside className="w-64 bg-slate-900 text-white flex-shrink-0 flex flex-col shadow-2xl">
        <div className="p-8 border-b border-white/5">
          <div className="flex items-center space-x-2">
            <Activity className="text-blue-400" size={24} />
            <h1 className="text-xl font-black italic tracking-tighter">CS-App</h1>
          </div>
        </div>
        <nav className="p-4 flex-1 space-y-2">
          <NavItem id="dashboard" icon={LayoutDashboard} label="Dashboard" active={activeTab} set={setActiveTab} />
          <NavItem id="absensi" icon={ClipboardCheck} label="Absensi Obat" active={activeTab} set={setActiveTab} />
          <NavItem id="obat" icon={Droplets} label="Panduan Obat" active={activeTab} set={setActiveTab} />
          <NavItem id="evaluasi" icon={TrendingUp} label="Evaluasi Gizi" active={activeTab} set={setActiveTab} />
        </nav>
        <div className="p-6 border-t border-white/5">
          <button onClick={handleLogout} className="w-full flex items-center space-x-3 text-slate-400 hover:text-white transition-colors px-4 py-2">
            <LogOut size={18} />
            <span className="text-sm font-bold">Keluar Sesi</span>
          </button>
        </div>
      </aside>

      {/* Konten Utama */}
      <main className="flex-1 flex flex-col overflow-hidden">
        <header className="bg-white border-b border-slate-200 h-20 flex items-center justify-between px-10">
          <div>
            <h2 className="text-lg font-black text-slate-800 capitalize tracking-tight">{activeTab.replace('-', ' ')}</h2>
            <p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Sesi Aktif: {userRole}</p>
          </div>
          <div className="text-right">
            <p className="text-xs font-bold text-slate-500 uppercase tracking-tighter">{new Date().toLocaleDateString('id-ID', { weekday: 'long' })}</p>
            <p className="text-sm font-black">{new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
          </div>
        </header>

        <div className="flex-1 overflow-y-auto p-10">
          {/* Dashboard Tab */}
          {activeTab === 'dashboard' && (
            <div className="space-y-8">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                <StatCard label="Total Balita" value={stats.total} color="blue" />
                <StatCard label="Rerata Kepatuhan" value={`${stats.avgCompliance}%`} color="emerald" progress={stats.avgCompliance} />
                <StatCard label="Risiko Tinggi" value={stats.highRisk} color="rose" alert />
              </div>
              <div className="bg-white p-8 rounded-[2rem] shadow-sm border border-slate-100">
                <h3 className="text-lg font-black text-slate-800 mb-6 flex items-center">
                  <AlertTriangle className="text-rose-500 mr-2" size={20} /> Butuh Perhatian Segera
                </h3>
                <div className="space-y-3">
                  {balitaList.filter(b => calculateCompliance(b.absensi) < 80).map(b => (
                    <div key={b.id} className="flex items-center justify-between p-4 bg-slate-50 rounded-2xl">
                      <div><p className="font-bold text-slate-800">{b.nama}</p><p className="text-[10px] text-slate-400 font-bold uppercase">{b.ortu}</p></div>
                      <div className="text-right"><p className="text-rose-600 font-black">{calculateCompliance(b.absensi)}%</p><p className="text-[8px] text-slate-400 font-bold">KEPATUHAN</p></div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}

          {/* Absensi Tab */}
          {activeTab === 'absensi' && (
            <div className="space-y-6">
              <div className="relative max-w-md">
                <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size={18} />
                <input type="text" placeholder="Cari Balita..." className="w-full pl-12 pr-4 py-4 rounded-2xl border-2 border-slate-100 focus:border-indigo-500 outline-none transition-all font-bold text-slate-700" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
              </div>
              <div className="bg-white rounded-[2rem] shadow-sm border border-slate-100 overflow-hidden">
                <table className="w-full text-left border-collapse">
                  <thead>
                    <tr className="bg-slate-50 text-slate-400 text-[10px] font-black uppercase tracking-widest"><th className="px-8 py-6">Balita</th>{['S','S','R','K','J','S','M'].map((d,i)=><th key={i} className="px-2 py-6 text-center">{d}</th>)}<th className="px-8 py-6 text-right">Skor</th></tr>
                  </thead>
                  <tbody className="divide-y divide-slate-100">
                    {filteredBalita.map((b) => (
                      <tr key={b.id} className="hover:bg-slate-50/50">
                        <td className="px-8 py-6"><div><p className="font-black text-slate-800">{b.nama}</p><p className="text-[10px] text-slate-400 font-bold uppercase">{b.obat}</p></div></td>
                        {b.absensi.map((status, idx) => (
                          <td key={idx} className="px-2 py-6 text-center">
                            <button onClick={() => toggleAbsensi(b.id, idx)} className={`p-1 transition-all ${status ? 'text-emerald-500' : 'text-slate-200 hover:text-slate-400'}`}>
                              {status ? <CheckCircle2 size={24} fill="currentColor" className="text-white bg-emerald-500 rounded-full" /> : <Clock size={24} />}
                            </button>
                          </td>
                        ))}
                        <td className="px-8 py-6 text-right"><span className={`px-3 py-1 rounded-lg text-[10px] font-black ${calculateCompliance(b.absensi) > 80 ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700'}`}>{calculateCompliance(b.absensi)}%</span></td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          {/* Panduan Obat (Animasi Interaktif) Tab */}
          {activeTab === 'obat' && (
            <div className="max-w-4xl mx-auto bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-12 items-center">
                <div className="flex flex-col items-center">
                  <div className="relative w-72 h-72 bg-indigo-50 rounded-[3rem] flex items-center justify-center border-4 border-white shadow-xl overflow-hidden">
                    <div className={`text-9xl transition-all duration-700 transform ${stepObat % 2 === 0 ? 'scale-110 -rotate-3' : 'scale-95 rotate-3'}`}>
                      {["üßº", "ü•Ñ", "üë∂", "üçº"][stepObat]}
                    </div>
                    <div className="absolute inset-0 border-2 border-indigo-200 rounded-full animate-ping opacity-10"></div>
                  </div>
                </div>
                <div className="space-y-4">
                  <h3 className="text-2xl font-black mb-6">Langkah Pemberian Obat</h3>
                  {[
                    { t: "Kebersihan", d: "Cuci tangan dengan sabun." },
                    { t: "Dosis Tepat", d: "Gunakan sendok takar asli." },
                    { t: "Posisi Anak", d: "Anak dipangku tegak 45¬∞." },
                    { t: "Berikan Pelan", d: "Teteskan di sisi dalam mulut." }
                  ].map((s, i) => (
                    <div key={i} onClick={() => setStepObat(i)} className={`p-5 rounded-2xl cursor-pointer transition-all border-2 ${stepObat === i ? 'bg-indigo-600 border-indigo-600 text-white shadow-lg' : 'bg-white border-slate-100 text-slate-500'}`}>
                      <div className="flex items-center space-x-4">
                        <span className={`w-8 h-8 flex items-center justify-center rounded-lg font-black ${stepObat === i ? 'bg-white text-indigo-600' : 'bg-slate-100'}`}>{i+1}</span>
                        <div><p className="font-black text-lg">{s.t}</p>{stepObat === i && <p className="text-xs mt-1 text-indigo-100 leading-relaxed">{s.d}</p>}</div>
                      </div>
                    </div>
                  ))}
                  <button onClick={() => setStepObat(p => (p < 3 ? p + 1 : 0))} className="w-full mt-4 bg-indigo-600 text-white py-4 rounded-2xl font-black shadow-lg hover:bg-indigo-700 transition-all">Lanjut Langkah Berikutnya</button>
                </div>
              </div>
            </div>
          )}

          {/* Evaluasi Gizi Tab */}
          {activeTab === 'evaluasi' && (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
              {balitaList.map(b => (
                <div key={b.id} className="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100">
                  <div className="flex justify-between items-start mb-6">
                    <div><h4 className="text-xl font-black text-slate-800">{b.nama}</h4><p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-1">{b.nik}</p></div>
                    <span className="px-4 py-1.5 rounded-full text-[10px] font-black uppercase bg-amber-100 text-amber-700">{b.statusGizi}</span>
                  </div>
                  <div className="grid grid-cols-2 gap-4 mb-6">
                    <div className="p-4 bg-slate-50 rounded-2xl"><p className="text-[10px] text-slate-400 font-black uppercase mb-1">Tinggi</p><p className="text-xl font-black">{b.tbSekarang} cm <span className="text-xs text-emerald-500">+{ (b.tbSekarang - b.tbAwal).toFixed(1) }</span></p></div>
                    <div className="p-4 bg-slate-50 rounded-2xl"><p className="text-[10px] text-slate-400 font-black uppercase mb-1">Berat</p><p className="text-xl font-black">{b.bbSekarang} kg <span className="text-xs text-emerald-500">+{ (b.bbSekarang - b.bbAwal).toFixed(1) }</span></p></div>
                  </div>
                  <div className="bg-indigo-50 p-4 rounded-xl text-xs text-indigo-700 leading-relaxed font-bold italic">"{b.catatan}"</div>
                </div>
              ))}
            </div>
          )}
        </div>
      </main>
    </div>
  );
};

// --- Komponen Pendukung ---
const NavItem = ({ id, icon: Icon, label, active, set }) => (
  <button onClick={() => set(id)} className={`w-full flex items-center space-x-3 px-6 py-4 rounded-2xl transition-all ${active === id ? 'bg-white/10 text-white shadow-xl' : 'text-slate-400 hover:text-white'}`}>
    <Icon size={18} /><span className="text-sm font-black">{label}</span>
  </button>
);

const StatCard = ({ label, value, color, progress, alert }) => (
  <div className="bg-white p-8 rounded-[2rem] shadow-sm border border-slate-100 relative overflow-hidden group">
    <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">{label}</p>
    <div className="flex items-center justify-between">
      <h3 className={`text-3xl font-black ${alert ? 'text-rose-600' : 'text-slate-800'}`}>{value}</h3>
      {alert && <AlertTriangle className="text-rose-500 animate-bounce" size={24} />}
    </div>
    {progress !== undefined && (
      <div className="mt-4 w-full bg-slate-100 h-1.5 rounded-full overflow-hidden">
        <div className="bg-emerald-500 h-full transition-all duration-1000" style={{ width: `${progress}%` }}></div>
      </div>
    )}
  </div>
);

export default App;
